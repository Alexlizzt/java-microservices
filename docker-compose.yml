networks:
  microservices_net:
    driver: bridge

services:
  # ======================================================
  # MYSQL - Base de datos para Booking
  # ======================================================
  mysql-booking:
    image: mysql:9.1
    container_name: booking-mysql-db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - microservices_net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-pRootP@ss123"]
      interval: 10s
      retries: 5
      start_period: 30s
      timeout: 5s

  # ======================================================
  # MONGO - Base de datos para Products
  # ======================================================
  mongo-product:
    image: mongo:8.0
    container_name: product-mongodb
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - microservices_net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      retries: 5
      start_period: 30s
      timeout: 5s

  # ======================================================
  # RabbitMQ - Mensajería
  # ======================================================
  rabbitmq:
    image: rabbitmq:4-management
    container_name: rabbitmq-project
    restart: always
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - microservices_net
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_port_connectivity"]
      interval: 10s
      retries: 5
      start_period: 30s
      timeout: 5s

  # ======================================================
  # KEYCLOAK - Autenticación y autorización
  # ======================================================
  keycloak-postgres:
    image: postgres:${POSTGRES_VERSION:-16}
    container_name: keycloak-postgres-db
    restart: always
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-keycloakdb}
      POSTGRES_USER: ${POSTGRES_USER:-kcuser}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-kcpass}
    volumes:
      - keycloak_postgres_data:/var/lib/postgresql/data
    networks:
      - microservices_net

  keycloak-server:
    image: quay.io/keycloak/keycloak:${KEYCLOAK_VERSION:-26.0}
    container_name: keycloak-server
    command: ["start-dev"]
    restart: always
    environment:
      KEYCLOAK_ADMIN: ${KC_BOOTSTRAP_ADMIN_USERNAME:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KC_BOOTSTRAP_ADMIN_PASSWORD:-admin}
      KC_DB: postgres
      KC_DB_URL_HOST: keycloak-postgres
      KC_DB_URL_DATABASE: ${POSTGRES_DB:-keycloakdb}
      KC_DB_USERNAME: ${POSTGRES_USER:-kcuser}
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD:-kcpass}
      KC_HEALTH_ENABLED: true
    ports:
      - "${KEYCLOAK_PORT:-8080}:8080"
    depends_on:
      - keycloak-postgres
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "exec 3<>/dev/tcp/127.0.0.1/9000; echo -e 'GET /health/ready HTTP/1.1\r\nhost: localhost\r\nConnection: close\r\n\r\n' >&3; if [ $? -eq 0 ]; then exit 0; else exit 1; fi;",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - microservices_net

  keycloak-configurator:
    image: adorsys/keycloak-config-cli:${KEYCLOAK_CONFIG_CLI_VERSION:-6.0.0}
    container_name: keycloak-configurator
    environment:
      KEYCLOAK_URL: http://keycloak-server:8080
      KEYCLOAK_USER: ${KC_BOOTSTRAP_ADMIN_USERNAME:-admin}
      KEYCLOAK_PASSWORD: ${KC_BOOTSTRAP_ADMIN_PASSWORD:-admin}
      IMPORT_PATH: /config
    depends_on:
      keycloak-server:
        condition: service_healthy
    volumes:
      - ./config:/config
    command: ["java", "-jar", "/app/keycloak-config-cli.jar"]
    networks:
      - microservices_net

# ======================================================
# VOLUMES
# ======================================================
volumes:
  mysql_data:
  mongo_data:
  rabbitmq_data:
  keycloak_postgres_data:
